<!DOCTYPE html>
<html>
<head>
<title>Mobile Pong</title>
<meta name="viewport" content="width=device-width, user-scalable=no">
<style type="text/css">
body {margin: 0px; overflow: hidden;}
canvas {border: 1px solid black;}
</style>
<script src="jquery-1.12.1.min.js"></script>
<script>
var canvas;
var context;
var touches = [];
var p1x = .5;
var p2x = .5;
var p1ybound = .8;
var p2ybound = .2;
var p1y = (p1ybound + .5 * (1 - p1ybound));
var p2y = .5 * p2ybound;
var paddlelength = .25;
var paddlewidth = .02;
var paddlexmin = paddlelength / 2;
var paddlexmax = 1 - paddlelength / 2;
var ballx = .5;
var bally = .5;
var ballvx = .001;
var ballvy = .006;
var ballvybase = .006;
// ballsize is absolute
var ballsize = 15;
var width = 0;
var height = 0;
var frame = false;
var startingtime = new Date().getTime();
var paused = false;
var released = false;
var lasttime = new Date().getTime();
var p1scored = false;
var p2scored = false;
var gameover = true;

function p1scoreevent() {

}

function p2scoreevent() {

}

function physics() {
    if (bally < p1y && bally + ballvy >= p1y && 
        ballx < p1x + paddlelength / 2 && ballx > p1x - paddlelength / 2) {
        ballvy *= -1;
        ballvx += (ballx - p1x) * .025;
    }
    if (bally > p2y && bally + ballvy <= p2y && 
        ballx < p2x + paddlelength / 2 && ballx > p2x - paddlelength / 2) {
        ballvy *= -1;
        ballvx += (ballx - p2x) * .025;
    }
    if (!paused) {
        ballx += ballvx;
        bally += ballvy;
    }
    if (ballx > 1 || ballx < 0) {
        ballvx *= -1;
    }
    if (bally > 1 || bally < 0) {
        if (bally > 1) {
            return "p1";
        }
        else {
            return "p2";
        }
    }
    return "continue";
}

function renderpaddles() {
    // draw p1
    context.beginPath();
    context.rect(p1x * width - .5 * width * paddlelength, p1y * height, width * paddlelength, height * paddlewidth);
    context.fillStyle = "rgba(255, 0, 0, 0.5)";
    context.fill();
    context.lineWidth = 2.0;
    context.strokeStyle = "rgba(255, 0, 0, 1)";
    context.stroke();
    context.closePath();

    // draw p2
    context.beginPath();
    context.rect(p2x * width - .5 * width * paddlelength, p2y * height, width * paddlelength, height * paddlewidth);
    context.fillStyle = "rgba(0, 0, 255, 0.5)";
    context.fill();
    context.lineWidth = 2.0;
    context.strokeStyle = "rgba(0, 0, 255, 1)";
    context.stroke();
    context.closePath();
}

function renderball() {
    // draw the ball
    context.beginPath();
    context.rect(ballx * width - .5 * ballsize, bally * height - .5 * ballsize, ballsize, ballsize);
    context.fillStyle = "rgba(0, 0, 0, 0.7)";
    context.fill();
    context.lineWidth = 2.0;
    context.strokeStyle = "rgba(0, 0, 0, 1)";
    context.stroke();
    context.closePath();
}

function processtouches() {
/*    if (touches.length == 0) {
        released = true;
    }
    var p1ready = false;
    var p2ready = false;*/
    var touched = [0, 0];
    for (var i = 0; i < touches.length; ++i) {
        var touch = touches[i];
        var tx = touch.pageX;
        var ty = touch.pageY;
        if (ty / height > p1ybound) {
            p1x = tx / width;
/*            if (paused && released) {
                p1ready = true;
            }*/
            touched[0] = 1;
        }
        if (ty / height < p2ybound) {
            p2x = tx / width;
/*            if (paused && released) {
                p2ready = true;
            }*/
            touched[1] = 1;
        }
    }
/*    if (p1ready && p2ready) {
        paused = false;
    }*/
    return touched;
}

function updatedimensions() {
    if (width != window.innerWidth || height != window.innerHeight) {
        width = window.innerWidth;
        height = window.innerHeight;
        canvas.style.width = width+"px";
        canvas.style.height = height+"px";
        canvas.width = width;
        canvas.height = height;
        console.log("width or height changed");
    }
}

function renderpoint() {
    var scored = physics();
    if (scored != "continue") {
        return scored;
    }
    ballvy = ballvy + ballvy * .000001;
    ballvx = ballvx + ballvx * .000001;
    if (frame) return;
    frame = true;

    updatedimensions();

    context.clearRect(0, 0, width, height);

    processtouches();

    renderpaddles();

    renderball();

    frame = false;
    return "continue";
}

function playpoint(callback) {
    p1x = .5;
    p2x = .5;
    ballx = .5;
    bally = .5;
    ballvx = .001;
    ballvy = .006;
    p1scored = false;
    p2scored = false;
    renderint = setInterval(function() {
        var result = renderpoint();        
        if (result != "continue") {
            clearInterval(renderint);
            callback(result);
        }
    }, 16);
}

function renderstart() {
    updatedimensions();
    context.clearRect(0, 0, width, height);
    touched = processtouches();
    if (touched[0] == 1 && touched[1] == 1) {
        return "startgame";
    }
    renderpaddles();
    return "continue";
}

function renderpause() {

}

function renderfinal() {

}

function startscreen(callback) {
    renderint = setInterval(function() {
        var result = renderstart();
        if (result == "startgame") {
            clearInterval(startscreen);
            callback();
        }
    }, 16);
}

function pausescreen(p1score, p2score, callback) {
    callback();
}

function finalresult(p1score, p2score) {
    gameover = true;
}

function playgame() {
    startscreen(function() {
        function nextpoint(p1score, p2score, callback) {
            if (p1score >= 3 || p2score >= 3) {
                callback(p1score, p2score);
                return;
            }
            playpoint(function(result) {
                var p1s = p1score;
                var p2s = p2score;
                if (result == "p1") {
                    p1s += 1;
                } else {
                    p2s += 1;
                }
                pausescreen(p1s, p2s, function() {
                    nextpoint(p1s, p2s, callback)
                });
            });
        }
        nextpoint(0, 0, finalresult);
    });
}

$(document).ready(function() {
        canvas = document.getElementById('canvas');
        context = canvas.getContext('2d'); 

        /* handle user input */
        canvas.addEventListener('touchmove', function(event) {
            event.preventDefault();
            touches = event.touches;
        });
        canvas.addEventListener('touchend', function() {
        });
        canvas.addEventListener('touchstart', function() {
            touches = event.touches;
        });

        setInterval(function() {
            if (gameover) {
                gameover = false;
                playgame();
            }
        }, 50)
        });
</script>
</head>
<body>
<canvas id="canvas" width="300" height="300" style="top:0px; left:0px; width: 300px; height: 300px;"></canvas>
</body>
</html>
